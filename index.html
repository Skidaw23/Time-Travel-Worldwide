<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1.0"
  />
  <title>Quantum Nebula Globe Clock ‚Äì ES Module</title>
  <meta name="description" content="Spinning Three.js globe with static city time & weather demo using ES modules." />
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/"
      }
    }
  </script>
  <style>
    body { margin:0; overflow:hidden; background:#000; font-family:'Segoe UI',system-ui,sans-serif; color:#fff; }
    #globe-container { position:fixed; inset:0; width:100vw; height:100vh; z-index:0; }
    #ui-overlay { position:fixed; inset:0; pointer-events:none; z-index:2; }
    #search-bar { pointer-events:auto; position:absolute; top:30px; left:50%; transform:translateX(-50%); width:340px; z-index:100; }
    #search-input { width:100%; padding:16px 24px; border:none; border-radius:30px;
      background:rgba(255,255,255,0.1); color:#fff; -webkit-backdrop-filter:blur(15px); backdrop-filter:blur(15px);
      box-shadow:0 8px 32px rgba(0,255,255,0.3); transition:.4s; font-size:1.15em; }
    #search-input:focus { outline:none; box-shadow:0 0 40px rgba(0,255,255,0.85); transform:scale(1.05); }
    #suggestions { pointer-events:auto; position:absolute; width:340px; left:50%; transform:translateX(-50%); top:68px;
      background:rgba(0,0,0,0.95); color:#fff; border-radius:0 0 24px 24px;
      z-index:120; box-shadow:0 4px 32px rgba(0,255,255,0.25); max-height:260px; overflow-y:auto; }
    .suggestion-item { padding:8px 20px; cursor:pointer; transition:background .18s; }
    .suggestion-item:hover { background:rgba(0,255,255,0.09); color:cyan; }
    
    #nav-controls { pointer-events:auto; position:fixed; bottom:30px; left:50%; transform:translateX(-50%);
      display:flex; gap:12px; z-index:100; flex-wrap:wrap; justify-content:center; max-width:90vw; }
    .nav-btn { padding:12px 24px; border:none; border-radius:20px; background:rgba(0,255,255,0.15);
      color:#fff; cursor:pointer; font-size:0.95em; transition:.3s; -webkit-backdrop-filter:blur(15px); backdrop-filter:blur(15px);
      box-shadow:0 4px 20px rgba(0,255,255,0.3); font-weight:600; white-space:nowrap; }
    .nav-btn:hover { background:rgba(0,255,255,0.35); transform:translateY(-3px); box-shadow:0 6px 30px rgba(0,255,255,0.6); }
    .nav-btn:active { transform:translateY(-1px); }

    .city-card {
      position:absolute; padding:24px 32px; border-radius:28px;
      background:rgba(255,255,255,0.06); -webkit-backdrop-filter:blur(22px); backdrop-filter:blur(22px);
      box-shadow:0 0 50px rgba(0,255,255,0.5); pointer-events:auto;
      animation:float 8s ease-in-out infinite; border:1px solid rgba(0,255,255,0.4);
      transition:.5s cubic-bezier(0.175,0.885,0.32,1.475); width:260px; text-align:center;
      cursor:move; user-select:none;
    }
    .close-btn {
      position:absolute; top:8px; right:8px; width:32px; height:32px; border-radius:50%;
      background:rgba(255,50,50,0.8); border:none; color:#fff; cursor:pointer;
      font-size:18px; line-height:1; transition:.3s; display:flex; align-items:center; justify-content:center;
      min-width:44px; min-height:44px; /* Minimum touch target size for accessibility */
    }
    .close-btn:hover { background:rgba(255,20,20,1); transform:scale(1.15); }
    .city-card::before {
      content:''; position:absolute; inset:-4px; border-radius:32px;
      background:conic-gradient(from 0deg at 50% 50%, #00ffff, #ff00ff, #ffff00, #00ff00, #00ffff);
      z-index:-1; animation:pulseBorder 6s linear infinite; opacity:.8;
    }
    .city-card:hover { transform:translateY(-20px) scale(1.1); box-shadow:0 0 100px rgba(0,255,255,1); }
    .city-name { font-size:1.5em; font-weight:600; text-shadow:0 0 15px cyan; margin-bottom:8px; }
    .time { font-size:3.2em; font-weight:800; letter-spacing:-2px; margin:6px 0 2px; }
    .temp { font-size:1.9em; margin:4px 0; font-weight:600; }
    .weather { font-size:1.1em; display:flex; flex-direction:column; align-items:center; gap:4px; }
    .desc { font-size:0.95em; opacity:0.85; }
    .icon { width:54px; height:54px; }
    @keyframes float { 0%,100% { transform:translateY(0); } 50% { transform:translateY(-30px); } }
    @keyframes pulseBorder { to { transform:rotate(360deg); } }
    ::selection { background:#00ffff; color:#000; }
    @media (max-width:768px) {
      #nav-controls { bottom:15px; gap:8px; max-width:95vw; }
      .nav-btn { padding:10px 16px; font-size:0.85em; }
      .city-card { width:220px; padding:20px; }
      .time { font-size:2.4em; }
    }
    @media (max-width:640px) {
      .city-card { width:200px; padding:18px; }
      .city-name { font-size:1.3em; }
      .time { font-size:2.2em; }
      .temp { font-size:1.6em; }
      .weather { font-size:1em; }
      .icon { width:48px; height:48px; }
      #search-bar { width:85vw; }
      #search-input { font-size:1em; padding:14px 20px; }
      #suggestions { width:85vw; }
    }
    @media (max-width:480px) {
      #nav-controls { bottom:10px; gap:6px; }
      .nav-btn { padding:10px 14px; font-size:0.8em; }
      .city-card { width:180px; padding:16px; }
      .city-name { font-size:1.2em; }
      .time { font-size:2em; }
      .temp { font-size:1.4em; }
      .weather { font-size:0.9em; }
      .icon { width:42px; height:42px; }
      #search-bar { width:90vw; top:20px; }
      #search-input { font-size:0.95em; padding:12px 18px; }
      #suggestions { width:90vw; top:58px; }
    }
    @media (max-width:375px) {
      .nav-btn { padding:8px 12px; font-size:0.75em; }
      .city-card { width:160px; padding:14px; }
      .time { font-size:1.8em; }
      .temp { font-size:1.3em; }
      #search-bar { width:92vw; }
      #suggestions { width:92vw; }
    }
    @media (max-width:640px) and (orientation:landscape) {
      #nav-controls { gap:6px; }
      .nav-btn { padding:8px 12px; font-size:0.75em; }
      #search-bar { width:70vw; top:15px; }
      #suggestions { width:70vw; top:53px; }
    }
  </style>
</head>
<body>
  <div id="globe-container" role="img" aria-label="Animated 3D globe visualization"></div>
  <div id="ui-overlay">
    <div id="search-bar">
      <input id="search-input" type="text" placeholder="Add city ‚Üí Tokyo, Paris, Miami..." autocomplete="off" aria-label="Add city" />
    </div>
    <div id="suggestions" style="display:none" aria-live="polite"></div>
    <div id="nav-controls">
      <button class="nav-btn" id="random-city-btn" title="Add random city">üé≤ Random City</button>
      <button class="nav-btn" id="clear-all-btn" title="Clear all cards">üóëÔ∏è Clear All</button>
      <button class="nav-btn" id="toggle-rotate-btn" title="Toggle globe rotation">‚è∏Ô∏è Pause Rotation</button>
      <button class="nav-btn" id="fullscreen-btn" title="Toggle fullscreen">‚õ∂ Fullscreen</button>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // ---------- Static demo city & weather data ----------
    const cityData = {
      // Europe
      Amsterdam: { tz: 'Europe/Amsterdam', temp: 12, weather: 'clouds', desc: 'Partly cloudy', icon: '03d', country: 'Netherlands' },
      London:    { tz: 'Europe/London', temp: 10, weather: 'rain',   desc: 'Rain showers',   icon: '09d', country: 'United Kingdom' },
      Paris:     { tz:'Europe/Paris', temp:14, weather:'clouds', desc:'Cloudy', icon:'04d', country: 'France' },
      Berlin:    { tz:'Europe/Berlin', temp:9, weather:'clouds', desc:'Foggy', icon:'50d', country: 'Germany' },
      Rome:      { tz:'Europe/Rome', temp:18, weather:'clear', desc:'Sunny', icon:'01d', country: 'Italy' },
      Madrid:    { tz:'Europe/Madrid', temp:16, weather:'clear', desc:'Clear sky', icon:'01d', country: 'Spain' },
      Vienna:    { tz:'Europe/Vienna', temp:11, weather:'clouds', desc:'Overcast', icon:'04d', country: 'Austria' },
      Prague:    { tz:'Europe/Prague', temp:8, weather:'clouds', desc:'Cloudy', icon:'03d', country: 'Czech Republic' },
      Athens:    { tz:'Europe/Athens', temp:20, weather:'clear', desc:'Sunny', icon:'01d', country: 'Greece' },
      Stockholm: { tz:'Europe/Stockholm', temp:5, weather:'snow', desc:'Light snow', icon:'13d', country: 'Sweden' },
      Oslo:      { tz:'Europe/Oslo', temp:3, weather:'snow', desc:'Snowing', icon:'13d', country: 'Norway' },
      Copenhagen:{ tz:'Europe/Copenhagen', temp:7, weather:'rain', desc:'Light rain', icon:'10d', country: 'Denmark' },
      Helsinki:  { tz:'Europe/Helsinki', temp:2, weather:'snow', desc:'Heavy snow', icon:'13d', country: 'Finland' },
      Dublin:    { tz:'Europe/Dublin', temp:9, weather:'rain', desc:'Rainy', icon:'09d', country: 'Ireland' },
      Lisbon:    { tz:'Europe/Lisbon', temp:17, weather:'clear', desc:'Sunny', icon:'01d', country: 'Portugal' },
      Brussels:  { tz:'Europe/Brussels', temp:10, weather:'clouds', desc:'Cloudy', icon:'03d', country: 'Belgium' },
      Zurich:    { tz:'Europe/Zurich', temp:8, weather:'clouds', desc:'Partly cloudy', icon:'02d', country: 'Switzerland' },
      Warsaw:    { tz:'Europe/Warsaw', temp:6, weather:'clouds', desc:'Overcast', icon:'04d', country: 'Poland' },
      Budapest:  { tz:'Europe/Budapest', temp:12, weather:'clear', desc:'Clear', icon:'01d', country: 'Hungary' },
      Moscow:    { tz:'Europe/Moscow', temp:-5, weather:'snow', desc:'Cold & snowy', icon:'13d', country: 'Russia' },
      
      // Asia
      Tokyo:     { tz: 'Asia/Tokyo',    temp: 20, weather: 'clear',  desc: 'Sunny',          icon: '01d', country: 'Japan' },
      Dubai:     { tz: 'Asia/Dubai',    temp: 28, weather: 'clear',  desc: 'Sunny',          icon: '01d', country: 'UAE' },
      Singapore: { tz:'Asia/Singapore', temp:31, weather:'rain', desc:'Heavy rain', icon:'10d', country: 'Singapore' },
      Beijing:   { tz:'Asia/Shanghai', temp:15, weather:'clouds', desc:'Smoggy', icon:'50d', country: 'China' },
      Shanghai:  { tz:'Asia/Shanghai', temp:18, weather:'rain', desc:'Light rain', icon:'10d', country: 'China' },
      'Hong Kong':{ tz:'Asia/Hong_Kong', temp:26, weather:'clouds', desc:'Humid', icon:'02d', country: 'Hong Kong' },
      Seoul:     { tz:'Asia/Seoul', temp:12, weather:'clear', desc:'Clear', icon:'01d', country: 'South Korea' },
      Bangkok:   { tz:'Asia/Bangkok', temp:33, weather:'clear', desc:'Hot & sunny', icon:'01d', country: 'Thailand' },
      Mumbai:    { tz:'Asia/Kolkata', temp:29, weather:'rain', desc:'Monsoon', icon:'10d', country: 'India' },
      Delhi:     { tz:'Asia/Kolkata', temp:32, weather:'clear', desc:'Hot', icon:'01d', country: 'India' },
      Bangalore: { tz:'Asia/Kolkata', temp:24, weather:'clouds', desc:'Pleasant', icon:'02d', country: 'India' },
      Kolkata:   { tz:'Asia/Kolkata', temp:30, weather:'rain', desc:'Humid rain', icon:'10d', country: 'India' },
      Jakarta:   { tz:'Asia/Jakarta', temp:30, weather:'rain', desc:'Tropical rain', icon:'10d', country: 'Indonesia' },
      Manila:    { tz:'Asia/Manila', temp:29, weather:'rain', desc:'Rainy', icon:'09d', country: 'Philippines' },
      'Kuala Lumpur':{ tz:'Asia/Kuala_Lumpur', temp:31, weather:'rain', desc:'Thunderstorm', icon:'11d', country: 'Malaysia' },
      Hanoi:     { tz:'Asia/Bangkok', temp:27, weather:'clouds', desc:'Humid', icon:'03d', country: 'Vietnam' },
      Taipei:    { tz:'Asia/Taipei', temp:23, weather:'rain', desc:'Light rain', icon:'10d', country: 'Taiwan' },
      Istanbul:  { tz:'Europe/Istanbul', temp:15, weather:'clouds', desc:'Cloudy', icon:'04d', country: 'Turkey' },
      Tehran:    { tz:'Asia/Tehran', temp:19, weather:'clear', desc:'Sunny', icon:'01d', country: 'Iran' },
      Riyadh:    { tz:'Asia/Riyadh', temp:35, weather:'clear', desc:'Very hot', icon:'01d', country: 'Saudi Arabia' },
      Jerusalem: { tz:'Asia/Jerusalem', temp:22, weather:'clear', desc:'Sunny', icon:'01d', country: 'Israel' },
      
      // North America
      'New York':{ tz: 'America/New_York', temp: 7, weather: 'snow', desc: 'Light snow',     icon: '13d', country: 'USA' },
      'Los Angeles':{ tz:'America/Los_Angeles', temp:22, weather:'clear', desc:'Sunny', icon:'01d', country: 'USA' },
      Miami:     { tz:'America/New_York', temp:27, weather:'rain', desc:'Thunderstorm', icon:'11d', country: 'USA' },
      Chicago:   { tz:'America/Chicago', temp:5, weather:'snow', desc:'Snowy', icon:'13d', country: 'USA' },
      Houston:   { tz:'America/Chicago', temp:20, weather:'clouds', desc:'Cloudy', icon:'03d', country: 'USA' },
      Phoenix:   { tz:'America/Phoenix', temp:28, weather:'clear', desc:'Hot & dry', icon:'01d', country: 'USA' },
      Seattle:   { tz:'America/Los_Angeles', temp:12, weather:'rain', desc:'Rainy', icon:'09d', country: 'USA' },
      Boston:    { tz:'America/New_York', temp:6, weather:'snow', desc:'Cold', icon:'13d', country: 'USA' },
      'San Francisco':{ tz:'America/Los_Angeles', temp:16, weather:'clouds', desc:'Foggy', icon:'50d', country: 'USA' },
      'Las Vegas':{ tz:'America/Los_Angeles', temp:25, weather:'clear', desc:'Sunny', icon:'01d', country: 'USA' },
      Toronto:   { tz:'America/Toronto', temp:4, weather:'snow', desc:'Cold & snowy', icon:'13d', country: 'Canada' },
      Vancouver: { tz:'America/Vancouver', temp:10, weather:'rain', desc:'Rainy', icon:'09d', country: 'Canada' },
      Montreal:  { tz:'America/Toronto', temp:2, weather:'snow', desc:'Snowy', icon:'13d', country: 'Canada' },
      'Mexico City':{ tz:'America/Mexico_City', temp:20, weather:'clear', desc:'Pleasant', icon:'01d', country: 'Mexico' },
      Havana:    { tz:'America/Havana', temp:26, weather:'clear', desc:'Tropical', icon:'01d', country: 'Cuba' },
      
      // South America
      'Buenos Aires':{ tz:'America/Argentina/Buenos_Aires', temp:24, weather:'clear', desc:'Sunny', icon:'01d', country: 'Argentina' },
      'Rio de Janeiro':{ tz:'America/Sao_Paulo', temp:28, weather:'clear', desc:'Beach weather', icon:'01d', country: 'Brazil' },
      'S√£o Paulo':{ tz:'America/Sao_Paulo', temp:25, weather:'rain', desc:'Rainy', icon:'10d', country: 'Brazil' },
      Lima:      { tz:'America/Lima', temp:22, weather:'clouds', desc:'Overcast', icon:'04d', country: 'Peru' },
      Bogota:    { tz:'America/Bogota', temp:16, weather:'rain', desc:'Mountain rain', icon:'10d', country: 'Colombia' },
      Santiago:  { tz:'America/Santiago', temp:23, weather:'clear', desc:'Clear', icon:'01d', country: 'Chile' },
      Caracas:   { tz:'America/Caracas', temp:27, weather:'clouds', desc:'Tropical', icon:'02d', country: 'Venezuela' },
      
      // Africa
      Cairo:     { tz:'Africa/Cairo', temp:26, weather:'clear', desc:'Sunny', icon:'01d', country: 'Egypt' },
      'Cape Town':{ tz:'Africa/Johannesburg', temp:21, weather:'clear', desc:'Beautiful', icon:'01d', country: 'South Africa' },
      Johannesburg:{ tz:'Africa/Johannesburg', temp:19, weather:'clouds', desc:'Partly cloudy', icon:'02d', country: 'South Africa' },
      Lagos:     { tz:'Africa/Lagos', temp:30, weather:'rain', desc:'Humid rain', icon:'10d', country: 'Nigeria' },
      Nairobi:   { tz:'Africa/Nairobi', temp:22, weather:'clear', desc:'Pleasant', icon:'01d', country: 'Kenya' },
      Casablanca:{ tz:'Africa/Casablanca', temp:19, weather:'clear', desc:'Sunny', icon:'01d', country: 'Morocco' },
      Addis_Ababa:{ tz:'Africa/Addis_Ababa', temp:18, weather:'clouds', desc:'Mild', icon:'03d', country: 'Ethiopia' },
      
      // Oceania
      Sydney:    { tz:'Australia/Sydney', temp:25, weather:'clouds', desc:'Partly cloudy', icon:'02d', country: 'Australia' },
      Melbourne: { tz:'Australia/Melbourne', temp:20, weather:'rain', desc:'Rainy', icon:'09d', country: 'Australia' },
      Brisbane:  { tz:'Australia/Brisbane', temp:27, weather:'clear', desc:'Sunny', icon:'01d', country: 'Australia' },
      Perth:     { tz:'Australia/Perth', temp:28, weather:'clear', desc:'Hot', icon:'01d', country: 'Australia' },
      Auckland:  { tz:'Pacific/Auckland', temp:18, weather:'clouds', desc:'Cloudy', icon:'03d', country: 'New Zealand' },
      Wellington:{ tz:'Pacific/Auckland', temp:16, weather:'rain', desc:'Windy & rainy', icon:'09d', country: 'New Zealand' },
      Fiji:      { tz:'Pacific/Fiji', temp:29, weather:'clear', desc:'Paradise', icon:'01d', country: 'Fiji' }
    };

    const weatherGradients = {
      rain:'linear-gradient(135deg,#232526,#414345)',
      snow:'linear-gradient(135deg,#e6e9f0,#eef2f3)',
      clouds:'linear-gradient(135deg,#757f9a,#d7dde8)',
      clear:'linear-gradient(135deg,#ff6e7f,#bfe9ff)',
      thunder:'linear-gradient(135deg,#141e30,#243b55)',
      default:'linear-gradient(135deg,#1e3c72,#2a5298)'
    };
    function getWeatherGradient(main) {
      if(!main) return weatherGradients.default;
      if(main.includes('rain')) return weatherGradients.rain;
      if(main.includes('snow')) return weatherGradients.snow;
      if(main.includes('cloud')) return weatherGradients.clouds;
      if(main.includes('clear')) return weatherGradients.clear;
      if(main.includes('thunder')) return weatherGradients.thunder;
      return weatherGradients.default;
    }

    // ---------- Three.js scene setup ----------
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(
      75,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(0,0,18);

    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.domElement.setAttribute('aria-hidden','true');
    document.getElementById('globe-container').appendChild(renderer.domElement);

    // Stars
    const starsGeom = new THREE.BufferGeometry();
    const starCount = 9000;
    const starVerts = new Float32Array(starCount * 3);
    for(let i=0;i<starCount;i++){
      starVerts[i*3]   = (Math.random()-0.5)*3200;
      starVerts[i*3+1] = (Math.random()-0.5)*3200;
      starVerts[i*3+2] = (Math.random()-0.5)*900;
    }
    starsGeom.setAttribute('position', new THREE.BufferAttribute(starVerts,3));
    const stars = new THREE.Points(
      starsGeom,
      new THREE.PointsMaterial({ color:0xffffff, size:0.8, sizeAttenuation:true })
    );
    scene.add(stars);

    // Globe
    const globeTexture = new THREE.TextureLoader().load(
      'https://unpkg.com/three-globe@2.31.1/example/img/earth-blue-marble.jpg',
      undefined,
      undefined,
      (err)=>console.error('Texture load error:', err)
    );
    const earth = new THREE.Mesh(
      new THREE.SphereGeometry(5,64,64),
      new THREE.MeshPhongMaterial({ map:globeTexture, color:0x2266bb, emissive:0x112255 })
    );
    scene.add(earth);

    const atmosphere = new THREE.Mesh(
      new THREE.SphereGeometry(5.15,64,64),
      new THREE.MeshBasicMaterial({ color:0x00ffff, transparent:true, opacity:0.13, side:THREE.BackSide })
    );
    scene.add(atmosphere);

    // Lighting
    scene.add(new THREE.AmbientLight(0x4040ff, 0.9));
    const dirLight = new THREE.DirectionalLight(0xffffff,2);
    dirLight.position.set(60,40,50);
    scene.add(dirLight);

    // Controls
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.autoRotate = true;
    controls.autoRotateSpeed = 0.35;
    controls.enablePan = false;
    controls.minDistance = 12;
    controls.maxDistance = 30;

    // ---------- City cards & UI ----------
    const activeCities = ['Amsterdam','Tokyo','New York'];
    const cards = {};
    
    // Improved grid-based positioning to prevent overlaps
    function cityCardPosition(idx,total) {
      const isMobile = window.innerWidth <= 768;
      const isSmallMobile = window.innerWidth <= 480;
      
      const cardWidth = isSmallMobile ? 180 : (isMobile ? 220 : 300);
      const cardHeight = isSmallMobile ? 240 : (isMobile ? 260 : 280);
      const padding = isMobile ? 10 : 20;
      
      const maxCols = isMobile ? (isSmallMobile ? 1 : 2) : Math.floor(window.innerWidth / (cardWidth + padding));
      const cols = Math.min(Math.ceil(Math.sqrt(total * 1.5)), maxCols);
      const rows = Math.ceil(total / cols);
      
      const col = idx % cols;
      const row = Math.floor(idx / cols);
      
      const totalWidth = cols * (cardWidth + padding);
      const totalHeight = rows * (cardHeight + padding);
      
      const startX = Math.max(padding, (window.innerWidth - totalWidth) / 2);
      const startY = isMobile ? Math.max(80, (window.innerHeight - totalHeight) / 2) : Math.max(120, (window.innerHeight - totalHeight) / 2);
      
      return { 
        left: `${startX + col * (cardWidth + padding)}px`, 
        top: `${startY + row * (cardHeight + padding)}px` 
      };
    }

    function svgIconStub(code){
      // Minimal inline icon replacement (avoid remote PNG dependency).
      // Map codes to simple glyph color variations:
      const colorMap = {
        '01': '#ffd700',
        '02': '#e0e0e0',
        '03': '#b0b0b0',
        '04': '#888',
        '09': '#4fa4ff',
        '10': '#3178c6',
        '11': '#ff4f4f',
        '13': '#ffffff',
        '50': '#a0a0a0',
      };
      const color = colorMap[code.substring(0, 2)] || '#00ffff';
      return `<svg class="icon" viewBox="0 0 64 64" fill="none" stroke="${color}" stroke-width="3" aria-hidden="true">
        <circle cx="32" cy="32" r="20" fill="${color}22"></circle>
        <path d="M20 32h24M32 20v24" stroke-linecap="round"/>
      </svg>`;
    }

    function updateCard(card, city) {
      const data = cityData[city];
      if(!data) return;
      const now = new Date();
      const timeStr = now.toLocaleTimeString('en-GB', { timeZone:data.tz, hour:'2-digit', minute:'2-digit', hour12:false });
      const dateStr = now.toLocaleDateString('en-GB', { timeZone:data.tz, weekday:'short', day:'numeric', month:'short' });
      const gradient = getWeatherGradient(data.weather);
      const iconSvg = svgIconStub(data.icon);
      card.innerHTML = `
        <button class="close-btn" aria-label="Remove ${city}" title="Remove card">‚úï</button>
        <div class="city-name">${city}</div>
        <div class="time" aria-label="Local time">${timeStr}</div>
        <div class="temp" aria-label="Temperature">${data.temp}¬∞C</div>
        <div class="weather">${iconSvg}${data.desc}</div>
        <div class="desc" aria-label="Date">${dateStr}</div>
      `;
      card.style.background = `${gradient}, rgba(255,255,255,0.06)`;
      
      // Add close button functionality
      const closeBtn = card.querySelector('.close-btn');
      closeBtn.onclick = (e) => {
        e.stopPropagation();
        removeCity(city);
      };
    }
    
    function removeCity(city) {
      const idx = activeCities.indexOf(city);
      if(idx === -1) return;
      
      const card = cards[city];
      if(card) {
        card.style.transition = 'all 0.4s ease-out';
        card.style.opacity = '0';
        card.style.transform = 'scale(0) rotate(180deg)';
        setTimeout(() => {
          card.remove();
          delete cards[city];
        }, 400);
      }
      
      activeCities.splice(idx, 1);
      
      // Reposition remaining cards
      setTimeout(() => repositionAllCards(), 450);
    }
    
    function repositionAllCards() {
      activeCities.forEach((city, idx) => {
        const card = cards[city];
        if(card) {
          const pos = cityCardPosition(idx, activeCities.length);
          card.style.left = pos.left;
          card.style.top = pos.top;
        }
      });
    }

    function addCityWithExplosion(city){
      if(!cityData[city] || activeCities.includes(city)) return;
      activeCities.push(city);
      const card = document.createElement('div');
      card.className='city-card';
      const pos = cityCardPosition(activeCities.length-1, activeCities.length);
      card.style.left = pos.left;
      card.style.top  = pos.top;
      card.style.opacity='0';
      card.style.transform='scale(0)';
      document.getElementById('ui-overlay').appendChild(card);
      cards[city] = card;
      
      // Add drag functionality
      let isDragging = false;
      let currentX, currentY, initialX, initialY;
      
      const startDrag = (e) => {
        if(e.target.classList.contains('close-btn')) return;
        isDragging = true;
        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        initialX = clientX - parseInt(card.style.left || 0);
        initialY = clientY - parseInt(card.style.top || 0);
        card.style.cursor = 'grabbing';
      };
      
      const doDrag = (e) => {
        if(!isDragging) return;
        e.preventDefault();
        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        currentX = clientX - initialX;
        currentY = clientY - initialY;
        card.style.left = currentX + 'px';
        card.style.top = currentY + 'px';
      };
      
      const endDrag = () => {
        if(isDragging) {
          isDragging = false;
          card.style.cursor = 'move';
          saveCardPositions();
        }
      };
      
      card.addEventListener('mousedown', startDrag);
      card.addEventListener('touchstart', startDrag, { passive: false });
      
      document.addEventListener('mousemove', doDrag);
      document.addEventListener('touchmove', doDrag, { passive: false });
      
      document.addEventListener('mouseup', endDrag);
      document.addEventListener('touchend', endDrag);
      
      setTimeout(()=>{
        card.style.transition='all 1s cubic-bezier(0.175,0.885,0.32,1.475)';
        card.style.opacity='1';
        card.style.transform='scale(1)';
        updateCard(card, city);
      },180);
    }
    
    // Save/restore card positions to localStorage
    function saveCardPositions() {
      const positions = {};
      activeCities.forEach(city => {
        const card = cards[city];
        if(card) {
          positions[city] = {
            left: card.style.left,
            top: card.style.top
          };
        }
      });
      localStorage.setItem('cardPositions', JSON.stringify(positions));
      localStorage.setItem('activeCities', JSON.stringify(activeCities));
    }
    
    function restoreCardPositions() {
      try {
        const savedCities = JSON.parse(localStorage.getItem('activeCities') || '[]');
        const savedPositions = JSON.parse(localStorage.getItem('cardPositions') || '{}');
        
        if(savedCities.length > 0) {
          activeCities.length = 0;
          activeCities.push(...savedCities);
          
          savedCities.forEach((city, i) => {
            if(cityData[city]) {
              setTimeout(() => {
                addCityWithExplosion(city);
                if(savedPositions[city]) {
                  setTimeout(() => {
                    const card = cards[city];
                    if(card) {
                      card.style.left = savedPositions[city].left;
                      card.style.top = savedPositions[city].top;
                    }
                  }, 200);
                }
              }, i * 200);
            }
          });
          return true;
        }
      } catch(e) {
        console.warn('Could not restore positions:', e);
      }
      return false;
    }

    // Load saved positions or show default cities
    if(!restoreCardPositions()) {
      activeCities.forEach((c,i)=>setTimeout(()=>{ if(!cards[c]) addCityWithExplosion(c); }, i*650));
    }

    // Search suggestions
    const searchInput = document.getElementById('search-input');
    const suggestionsDiv = document.getElementById('suggestions');

    function updateSuggestions(val){
      if(!val || val.length < 2){
        suggestionsDiv.innerHTML='';
        suggestionsDiv.style.display='none';
        return;
      }
      const matches = Object.keys(cityData).filter(c =>
        c.toLowerCase().includes(val.toLowerCase()) && !activeCities.includes(c)
      );
      if(!matches.length){
        suggestionsDiv.innerHTML='<div class="suggestion-item" style="color:gray;">No matches</div>';
        suggestionsDiv.style.display='block';
        return;
      }
      suggestionsDiv.innerHTML = matches.map(m=>`<div class="suggestion-item" role="option">${m}</div>`).join('');
      suggestionsDiv.style.display='block';
      suggestionsDiv.querySelectorAll('.suggestion-item').forEach(item=>{
        item.onclick = ()=>{
          addCityWithExplosion(item.textContent.trim());
          searchInput.value='';
          updateSuggestions('');
        };
      });
    }
    searchInput.addEventListener('input', ()=> updateSuggestions(searchInput.value.trim()));
    document.body.addEventListener('click', e=>{
      if(e.target !== searchInput) updateSuggestions('');
    }, true);
    searchInput.addEventListener('keydown', e=>{
      if(e.key === 'Enter'){
        const val = searchInput.value.trim();
        const matches = Object.keys(cityData).filter(c =>
          c.toLowerCase().includes(val.toLowerCase()) && !activeCities.includes(c)
        );
        if(matches.length){
          addCityWithExplosion(matches[0]);
          searchInput.value='';
          updateSuggestions('');
        }
      }
    });
    
    // Navigation button handlers
    document.getElementById('random-city-btn').addEventListener('click', () => {
      const availableCities = Object.keys(cityData).filter(c => !activeCities.includes(c));
      if(availableCities.length > 0) {
        const randomCity = availableCities[Math.floor(Math.random() * availableCities.length)];
        addCityWithExplosion(randomCity);
      }
    });
    
    document.getElementById('clear-all-btn').addEventListener('click', () => {
      if(confirm('Remove all city cards?')) {
        [...activeCities].forEach(city => removeCity(city));
        localStorage.removeItem('cardPositions');
        localStorage.removeItem('activeCities');
      }
    });
    
    let rotationEnabled = true;
    const toggleRotateBtn = document.getElementById('toggle-rotate-btn');
    toggleRotateBtn.addEventListener('click', () => {
      rotationEnabled = !rotationEnabled;
      controls.autoRotate = rotationEnabled;
      toggleRotateBtn.textContent = rotationEnabled ? '‚è∏Ô∏è Pause Rotation' : '‚ñ∂Ô∏è Resume Rotation';
    });
    
    document.getElementById('fullscreen-btn').addEventListener('click', () => {
      if(!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + K: Focus search
      if((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        searchInput.focus();
      }
      // Escape: Clear search
      if(e.key === 'Escape') {
        searchInput.value = '';
        updateSuggestions('');
        searchInput.blur();
      }
      // R: Add random city
      if(e.key === 'r' && !e.ctrlKey && !e.metaKey && document.activeElement !== searchInput) {
        document.getElementById('random-city-btn').click();
      }
      // Space: Toggle rotation
      if(e.key === ' ' && document.activeElement !== searchInput) {
        e.preventDefault();
        toggleRotateBtn.click();
      }
      // F: Toggle fullscreen
      if(e.key === 'f' && !e.ctrlKey && !e.metaKey && document.activeElement !== searchInput) {
        document.getElementById('fullscreen-btn').click();
      }
    });

    // ---------- Animation loop ----------
    let lastTime = null;
    const targetFPS = 60;
    const frameInterval = 1000 / targetFPS;
    
    renderer.setAnimationLoop((time)=>{
      // Initialize lastTime on first frame
      if (lastTime === null) {
        lastTime = time;
        earth.rotation.y += 0.0012;
        atmosphere.rotation.y += 0.0008;
        controls.update();
        renderer.render(scene, camera);
        return;
      }
      
      // Throttle to target FPS for performance
      const elapsed = time - lastTime;
      if (elapsed < frameInterval) return;
      lastTime = time - (elapsed % frameInterval);
      
      earth.rotation.y += 0.0012 * (elapsed / frameInterval);
      atmosphere.rotation.y += 0.0008 * (elapsed / frameInterval);
      controls.update();
      renderer.render(scene, camera);
    });

    // ---------- Resize handling ----------
    window.addEventListener('resize', ()=>{
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      // Reposition cards using improved layout
      repositionAllCards();
    });

    // ---------- Basic error boundary ----------
    window.addEventListener('error', (ev)=>{
      console.error('Runtime error:', ev.message);
    });
  </script>
</body>
</html>